<!doctype html>
<head>
  <title>CI radiator view</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  <script src="backends.js"></script>
</head>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    box-sizing:border-box;
    background: white;
    font-family: "Roboto", Helvetica, Arial, sans-serif;
  }
  ul {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }
  li {
    list-style: none;
    color: white;
    text-align: center;
    border-top: 1px solid rgba(0,0,0, 0.3);
    background-color: #e4e4e4;
  }
  li:first-child {
    border-top: 0;
  }
  .success, .fixed, .passed {
    background-color: #42c88a;
  }
  .failed, .infrastructure_fail, .timedout, .errored  {
    background-color: #ed5c5c;
  }
  .not_running, .queued, .scheduled, .canceled {
    background-color: #ab7fd1;
  }
  @keyframes pulse {
    50% { background-color: rgba(102, 211, 228, 0.6) }
  }
  .running, .started {
    animation: pulse 5s ease-in-out infinite;
    background-color: #66d3e4;
    background-color: rgba(102, 211, 228, 1.0);
  }

  .fill-height-or-more {
    flex-direction: column;
    display: flex;
    flex-wrap: wrap;
  }

  .fill-height-or-more > li {
    flex: 1 0 20%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-sizing: border-box;
    width: 100%;
  }

  .fill-height-or-more > li {
    border-right: 1px solid rgba(0,0,0, 0.3);
  }

  #radiator {
    display: none;
  }

  #error {
    display: none;
    text-align: center;
  }

  .settings-form {
    display: none;
    align-items: center;
    justify-content: center;
    height: inherit;
    background: #e4e4e4;
  }

  input[type="password"], input[type="submit"] {
    max-width: 50%;
    max-height: 25%;
    min-width: 320px;
    min-height: 60px;
  }

  @media (min-width: 410px) {
    .split-1 > li { max-width: calc(100% / 1); }
    .split-2 > li { max-width: calc(100% / 2); }
    .split-3 > li { max-width: calc(100% / 3); }
    .split-4 > li { max-width: calc(100% / 4); }
    .split-5 > li { max-width: calc(100% / 5); }
  }
</style>
<body>
  <div class="settings-form">
    <input type="password" id="apitoken" placeholder="API token" autofocus></input>
    <input type="submit" value="Begin" id="submit"></input>
  </div>

  <ul id="radiator" class="fill-height-or-more">
  </ul>
  <h1 id="error"></h1>

  <script>
   var updateInterval = 20 * 1000
   var settings

   var radiator = document.getElementById('radiator')
   var error = document.getElementById('error')

   function createJob(build) {
      var name = `${build.repository}: ${decodeURIComponent(build.branch)}`
      var time = new Date(build.started)

      var listItem = document.createElement('li')
      var header = document.createElement('h1')
      var description = document.createElement('time')

      header.textContent = name
      description.textContent = `
      ${time.getDate()}.${time.getMonth() + 1}.${time.getFullYear()}
      ${time.getHours()}:${time.getMinutes()}
      `

      listItem.innerHTML = header.outerHTML + description.outerHTML
      listItem.className = build.state

      radiator.innerHTML = radiator.innerHTML + listItem.outerHTML
   }

   function calculateColumns(data) {
      var builds = data.length
      return Math.min(5, Math.ceil(builds / 5))
   }

   function setRadiatorColumns(columns) {
      radiator.classList.remove([1, 2, 3, 4, 5, 6].map(n => 'split-' + n))
      radiator.classList.add('split-' + columns)
   }

   function createJobList(err, builds) {
      if (err) {
         return displayError(err)
      }
      setRadiatorColumns(calculateColumns(builds))
      radiator.innerHTML = ''
      radiator.style.display = 'flex'

      _.map(builds, createJob)
   }

   function displayError(message) {
      radiator.style.display = 'none'
      radiator.innerHTML = ''
      error.textContent = message
      error.style.display = 'block'
   }

   function start(settings) {
      var backend = buildBackend(settings, createJobList) || displayError('Invalid backend ' + settings.mode)
      setInterval(backend, updateInterval)
      backend()
      setInterval(function(){location.reload(true)}, 24 * 60 * 60 * 1000)
   }

   var query = window.location.search.substring(1)
   var settings = _.chain(query.split('&')).map(function(params) {
      var p = params.split('=')
      return [p[0], decodeURIComponent(p[1])]
   }).fromPairs().value()
   if (settings && settings.token) {
      start(settings)
   } else {
      var settingsForm = document.querySelector('.settings-form')
      settingsForm.style.display = 'flex'
      var apiTokenInput = document.getElementById('apitoken')
      var submit = document.getElementById('submit')
      submit.addEventListener('click', function() {
         settingsForm.style.display = 'none'
         settings.token = apiTokenInput.value
         start(settings)
      })
   }
  </script>
</body>
